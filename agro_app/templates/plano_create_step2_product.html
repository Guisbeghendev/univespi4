{% extends 'base.html' %}
{% load static %}

{% block title %}Novo Plano de Cultivo - Etapa 2{% endblock %}

{% block content %}

<div class="container" style="max-width: 1000px; margin: 40px auto; padding: 20px; background: #fff; border-radius: 8px; box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);">

    <h2 style="color: #38761d; border-bottom: 2px solid #38761d; padding-bottom: 10px; margin-bottom: 20px;">
        Novo Plano de Cultivo (2/2): Selecione o Cultivo
    </h2>

    <p style="margin-bottom: 15px; color: #555;">
        Terreno selecionado: <strong>{{ terreno.name }}</strong> (Área: {{ terreno.area|floatformat:"2" }} {{ terreno.unit }})
    </p>

    <p style="margin-bottom: 25px; color: #555; font-weight: bold;">
        Baseado em sua localização ({{ city_name }}), veja abaixo as sugestões de cultivo com maior pontuação:
    </p>

    {% if suggestions %}
        <div id="plano-product-selection" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px;">

            {% for suggestion in suggestions %}
            <div class="product-card" data-product-id="{{ suggestion.id }}" data-product-name="{{ suggestion.name }}"
                 style="border: 1px solid #ddd; border-left: 5px solid #38761d; padding: 15px; border-radius: 6px; **height: 280px;** transition: all 0.3s; background-color: #fcfcfc; overflow: hidden;">

                <h4 style="margin-top: 0; color: #333;">{{ suggestion.name }}</h4>
                <p style="font-size: 0.9em; color: #666;">
                    Pontuação Agro: <strong style="color: {% if suggestion.score >= 75 %}#38761d{% elif suggestion.score >= 50 %}#ff9900{% else %}#e06666{% endif %};">{{ suggestion.score }}%</strong>
                </p>

                <div id="details-{{ suggestion.id }}" style="margin-top: 10px; font-size: 0.85em; color: #777; **height: 120px; overflow-y: auto;**">
                    <p>Clique no botão para ver detalhes...</p>
                </div>

                <button type="button" class="btn btn-sm select-product-btn" data-product-id="{{ suggestion.id }}"
                        style="display: block; width: 100%; margin-top: 10px; background-color: #5cb85c; color: white; border: none;">
                    Selecionar e Ver Detalhes
                </button>
            </div>
            {% endfor %}

        </div>

        {# FORMULÁRIO DE FINALIZAÇÃO: Inicialmente escondido #}
        <div id="final-plano-form-container" style="margin-top: 40px; padding: 25px; border: 1px solid #38761d; border-radius: 8px; display: none;">
            <h3 style="color: #38761d; margin-top: 0;">Finalizar Plano de Cultivo</h3>

            <form id="plano-submit-form" method="post" action="{% url 'agro_app:save_plano' terreno_id=terreno.pk %}">
                {% csrf_token %}

                {# CORRIGIDO: Substituído {{ plano_form|crispy }} por {{ plano_form.as_p }} #}
                {{ plano_form.as_p }}

                {# Campo customizado para exibir o produto selecionado #}
                <div style="margin-bottom: 15px;">
                    <label>Cultivo Selecionado:</label>
                    <p id="selected-product-display" style="font-weight: bold; color: #007bff;">Nenhum</p>
                </div>

                <button type="submit" id="submit-plano-btn" class="btn btn-success" style="padding: 10px 30px;">
                    Criar Plano de Cultivo
                </button>
            </form>
        </div>

    {% else %}
        <div class="alert-warning" style="padding: 15px; background: #ffeeba; border: 1px solid #ffcc00; color: #856404; border-radius: 5px;">
            <p>Não foi possível gerar sugestões de cultivo para **{{ city_name }}** ou os dados agropecuários não estão disponíveis.</p>
        </div>
    {% endif %}

    <div style="margin-top: 30px; text-align: center;">
        <a href="{% url 'agro_app:create_plano' %}" style="color: #888; text-decoration: none;">&larr; Voltar para a Etapa 1</a>
        <span style="margin: 0 15px;">|</span>
        <a href="{% url 'agro_app:dashboard' %}" style="color: #888; text-decoration: none;">Voltar para a Dashboard</a>
    </div>

</div>

<script>
    const TERRENO_ID = "{{ terreno.pk }}";
    const API_URL_TEMPLATE = "/dashboard/api/plano-data/PLACEHOLDER_T/PLACEHOLDER_P";
    const finalFormContainer = document.getElementById('final-plano-form-container');
    const selectedProductDisplay = document.getElementById('selected-product-display');

    // Referências aos campos HIDDEN no formulário
    const inputCultura = document.getElementById('id_cultura');
    const inputTerreno = document.getElementById('id_terreno');

    // NOVA FUNÇÃO: Converte texto (productName) em um slug URL-friendly
    function slugify(text) {
        return text.toString().toLowerCase()
            .replace(/\s+/g, '-')           // Substitui espaços por -
            .replace(/[^\w\-]+/g, '')       // Remove caracteres não-palavra (exceto hífens)
            .replace(/\-\-+/g, '-')         // Substitui múltiplos hífens por um único
            .replace(/^-+/, '')             // Remove hífens do início
            .replace(/-+$/, '');            // Remove hífens do fim
    }

    document.addEventListener('DOMContentLoaded', function() {
        // Seleciona todos os NOVOS BOTÕES
        const selectButtons = document.querySelectorAll('.select-product-btn');
        const productCards = document.querySelectorAll('.product-card');

        selectButtons.forEach(button => {
            button.addEventListener('click', function() {
                const productId = this.getAttribute('data-product-id');
                const card = this.closest('.product-card'); // Encontra o card pai
                const productName = card.getAttribute('data-product-name');

                const productSlug = slugify(productName);
                const detailsDiv = document.getElementById(`details-${productId}`);

                // 1. Destaque do Card
                productCards.forEach(c => c.style.backgroundColor = '#fcfcfc');
                card.style.backgroundColor = '#e6ffe6';

                // 2. Preenche os campos hidden do Formulário e exibe o formulário
                inputCultura.value = productName;
                if (!inputTerreno.value) {
                    inputTerreno.value = TERRENO_ID;
                }

                selectedProductDisplay.textContent = productName;
                finalFormContainer.style.display = 'block';

                // 3. Carrega e exibe os detalhes, usando o productSlug para a URL
                loadProductDetails(productSlug, productName, detailsDiv, card);

                // Rola suavemente
                setTimeout(() => {
                    finalFormContainer.scrollIntoView({ behavior: 'smooth', block: 'start' });
                }, 100);
            });
        });

        async function loadProductDetails(productSlug, productName, detailsDiv, cardElement) {
            detailsDiv.innerHTML = '<p>Carregando dados detalhados...</p>';

            try {
                // Monta a URL da API substituindo os placeholders
                let url = API_URL_TEMPLATE.replace('PLACEHOLDER_T', TERRENO_ID);
                // CRUCIAL: Usa o SLUG (productSlug) para a URL
                url = url.replace('PLACEHOLDER_P', productSlug);

                const response = await fetch(url);
                const data = await response.json();

                if (!response.ok) {
                    detailsDiv.innerHTML = `<p style="color: red;">Erro ao carregar detalhes: ${data.error || 'Desconhecido'}</p>`;
                    return;
                }

                // Cria o HTML de detalhes
                let htmlContent = '<ul style="list-style: none; padding: 0;">';
                for (const key in data) {
                    if (data.hasOwnProperty(key)) {
                        htmlContent += `<li><strong>${key}:</strong> ${data[key]}</li>`;
                    }
                }
                htmlContent += '</ul>';

                // Mostra o nome do produto no formulário de finalização
                const planoFormTitle = finalFormContainer.querySelector('h3');
                planoFormTitle.textContent = `Finalizar Plano de Cultivo: ${productName}`;

                detailsDiv.innerHTML = htmlContent;

            } catch (error) {
                console.error('Erro na API de detalhes:', error);
                detailsDiv.innerHTML = `<p style="color: red;">Erro ao comunicar com o servidor.</p>`;
            }
        }
    });
</script>

{% endblock %}