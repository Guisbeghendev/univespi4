{% extends 'base.html' %}
{% load static %}

{% block content %}

<div class="dashboard-grid">

    {# inicio card1 #}
    <div class="dash-card dash-card-full">
        <h2 class="sub-title">Bem-vindo à Dashboard</h2>
        <p>Olá, {{ request.user.username }}! Esta é a sua dashboard pessoal.</p>
        <p>Você está em {{ city_name|default:"-" }} / {{ state_name|default:"-" }}</p>
        <p id="current-date"></p>
    </div>
    {# fim card1 #}

    {# inicio card2 #}
    <div class="dash-card">
        <h4>Detalhes do Clima em {{ city_name|default:"-" }}</h4>
        {% if weather_data %}
            <p><strong>Umidade:</strong> {{ weather_data.main.humidity|default:"-" }}%</p>
            <p><strong>Vento:</strong> {{ weather_data.wind.speed|default:"-" }} m/s</p>
            <p><strong>Pressão:</strong> {{ weather_data.main.pressure|default:"-" }} hPa</p>
        {% else %}
            <p>Dados de clima não disponíveis.</p>
        {% endif %}
    </div>
    {# fim card2 #}

    {# inicio card3 #}
    <div class="dash-card">
        <h4>Condição do Tempo em {{ city_name|default:"-" }}</h4>
        {% if weather_data %}
            <p>{{ weather_data.weather.0.description|default:"-"|title }}</p>
        {% else %}
            <p>Dados de clima não disponíveis.</p>
        {% endif %}
    </div>
    {# fim card3 #}

    {# inicio card4 - este card vai ocupar 2 espacos #}
    <div class="dash-card dash-card-wide">
    <h4>Temperatura em {{ city_name|default:"-" }}</h4>
    {% if weather_data %}
        <p style="font-size: 2.5rem; font-weight: bold; margin: 0;">{{ weather_data.main.temp|floatformat:"0" }}°C</p>
        <p>Sensação térmica: {{ weather_data.main.feels_like|floatformat:"0" }}°C</p>
        <p>Mínima: {{ weather_data.main.temp_min|floatformat:"0" }}°C / Máxima: {{ weather_data.main.temp_max|floatformat:"0" }}°C</p>
    {% else %}
        <p>Dados de temperatura não disponíveis.</p>
    {% endif %}
    </div>
    {# fim card4 #}

    <div class="filter-results-container dash-card-full">
        {# inicio card5 - Filtros #}
        <div class="dash-card">
            <h4>Filtros de Agropecuária</h4>
            <p>Selecione um produto para começar:</p>

            <p>1. Selecione o Estado:</p>
            <select id="state-select">
                <option value="">Carregando estados...</option>
            </select>

            <p>2. Selecione a Cidade:</p>
            <select id="city-select">
                <option value="">Selecione um estado primeiro</option>
            </select>

            <p>3. Selecione o Tipo de Cultivo:</p>
            <select id="produto-select">
                <option value="">Selecione uma cidade primeiro</option>
            </select>
            <div id="produto-error-message" style="color: red; margin-top: 5px; display: none;"></div>
        </div>
        {# fim card5 #}

        {# inicio card de Resultados - Nova Linha #}
        <div class="dash-card">
            <h4>Dados Detalhados</h4>
            <div id="results-display">
                <p>Selecione um estado, cidade e cultivo para ver os dados.</p>
            </div>
        </div>
        {# fim card de Resultados #}
    </div>

    {# inicio card6 #}
    <div class="dash-card dash-card-wide">
        <h4>⚙️ Sugestões de Plantio para {{ city_name|default:"sua Região" }}</h4>
        <p>Baseado no histórico de **Maior Rendimento (kg/ha)** e **Maior Valor (R$)** na sua cidade.</p>

        {% if suggestions %}
            <ul class="suggestion-list">
                {% for suggestion in suggestions %}
                    <li class="suggestion-item rank-{{ forloop.counter }}">
                        <span>
                            **{{ forloop.counter }}º** - {{ suggestion.name }}
                            <small>({{ suggestion.rendimento|floatformat:"0" }} kg/ha / R$ {{ suggestion.valor|floatformat:"0" }})</small>
                        </span>
                        <span class="suggestion-score">{{ suggestion.score }}%</span>
                    </li>
                {% endfor %}
            </ul>
        {% else %}
            {% if profile.city %}
                <p>Não foi possível gerar sugestões com base nos dados históricos da sua cidade. Certifique-se de que a cidade cadastrada possui dados de produção ou tente outra localização.</p>
            {% else %}
                <p>Por favor, complete seu cadastro de localização para receber as sugestões.</p>
            {% endif %}
        {% endif %}
    </div>
    {# fim card6 #}

    {# inicio card7 #}
    <div class="dash-card">
        <h4>Card 7</h4>
        <p>Conteúdo do Card 7</p>
    </div>
    {# fim card7 #}

</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const stateSelect = document.getElementById('state-select');
        const citySelect = document.getElementById('city-select');
        const produtoSelect = document.getElementById('produto-select');
        const produtoErrorMessageDiv = document.getElementById('produto-error-message');
        const resultsDisplayDiv = document.getElementById('results-display');
        const currentDateParagraph = document.getElementById('current-date');

        // Adiciona a data atual ao card 1
        const date = new Date();
        const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
        const formattedDate = date.toLocaleDateString('pt-BR', options);
        currentDateParagraph.textContent = `Hoje é ${formattedDate}.`;

        async function populateStatesDropdown() {
            stateSelect.innerHTML = '<option value="">Carregando estados...</option>';
            stateSelect.disabled = true;
            try {
                const response = await fetch('/dashboard/api/get-states/');
                if (!response.ok) {
                    throw new Error('Erro ao carregar os estados.');
                }
                const states = await response.json();
                stateSelect.innerHTML = '<option value="">Selecione um estado...</option>';
                states.forEach(state => {
                    const option = document.createElement('option');
                    option.value = state.id;
                    option.textContent = state.nome;
                    stateSelect.appendChild(option);
                });
            } catch (error) {
                console.error('Erro:', error);
                stateSelect.innerHTML = '<option value="">Erro ao carregar estados</option>';
            } finally {
                stateSelect.disabled = false;
            }
        }

        async function populateCitiesDropdown(stateId) {
            produtoSelect.innerHTML = '<option value="">Selecione uma cidade primeiro</option>';
            produtoSelect.disabled = true;
            if (!stateId) {
                citySelect.innerHTML = '<option value="">Selecione um estado primeiro</option>';
                citySelect.disabled = true;
                return;
            }
            citySelect.innerHTML = '<option value="">Carregando cidades...</option>';
            citySelect.disabled = true;
            try {
                const response = await fetch(`/dashboard/api/get-cities/${stateId}/`);
                if (!response.ok) {
                    throw new Error('Erro ao carregar as cidades.');
                }
                const cities = await response.json();
                citySelect.innerHTML = '<option value="">Selecione uma cidade...</option>';
                cities.forEach(city => {
                    const option = document.createElement('option');
                    option.value = city.id;
                    option.textContent = city.nome;
                    citySelect.appendChild(option);
                });
            } catch (error) {
                console.error('Erro:', error);
                citySelect.innerHTML = '<option value="">Erro ao carregar cidades</p>';
            } finally {
                citySelect.disabled = false;
            }
        }

        async function populateProductsDropdown(cityId) {
            produtoErrorMessageDiv.style.display = 'none';
            produtoSelect.disabled = true;
            if (!cityId) {
                produtoSelect.innerHTML = '<option value="">Selecione uma cidade primeiro</option>';
                return;
            }
            produtoSelect.innerHTML = '<option value="">Carregando produtos...</option>';
            try {
                const cityResponse = await fetch(`https://servicodados.ibge.gov.br/api/v1/localidades/municipios/${cityId}`);
                if (!cityResponse.ok) {
                    throw new Error('Erro ao carregar dados da cidade.');
                }
                const cityData = await cityResponse.json();
                const cityName = cityData.nome;

                const productsResponse = await fetch(`/dashboard/api/get-products-by-city/${cityName}/`);
                if (!productsResponse.ok) {
                    throw new Error('Erro ao carregar os produtos.');
                }

                const products = await productsResponse.json();

                if (products.length > 0) {
                    produtoSelect.innerHTML = '<option value="">Selecione um produto...</option>';
                    products.forEach(product => {
                        const option = document.createElement('option');
                        option.value = product.id;
                        option.textContent = product.nome;
                        produtoSelect.appendChild(option);
                    });
                } else {
                    produtoSelect.innerHTML = '<option value="">Nenhum produto encontrado</option>';
                }
            } catch (error) {
                console.error('Erro:', error);
                produtoErrorMessageDiv.textContent = 'Erro ao carregar os produtos.';
                produtoErrorMessageDiv.style.display = 'block';
                produtoSelect.innerHTML = '<option value="">Erro</option>';
            } finally {
                produtoSelect.disabled = false;
            }
        }

        // Função para exibir os dados detalhados
        async function displayDetailedData() {
            const selectedCityId = citySelect.value;
            const selectedProductId = produtoSelect.value;

            if (!selectedCityId || !selectedProductId) {
                resultsDisplayDiv.innerHTML = '<p>Selecione um estado, cidade e cultivo para ver os dados.</p>';
                return;
            }

            resultsDisplayDiv.innerHTML = '<p>Carregando dados...</p>';

            try {
                const cityResponse = await fetch(`https://servicodados.ibge.gov.br/api/v1/localidades/municipios/${selectedCityId}`);
                const cityData = await cityResponse.json();
                const cityName = cityData.nome;

                const response = await fetch(`/dashboard/api/get-detailed-data/${cityName}/${selectedProductId}/`);
                if (!response.ok) {
                    throw new Error('Erro ao carregar os dados detalhados.');
                }
                const data = await response.json();

                let htmlContent = '<h4>Informações para ' + cityName + '</h4><ul>';
                for (const key in data) {
                    if (data.hasOwnProperty(key)) {
                        htmlContent += '<li><strong>' + key + ':</strong> ' + data[key] + '</li>';
                    }
                }
                htmlContent += '</ul>';

                resultsDisplayDiv.innerHTML = htmlContent;

            } catch (error) {
                console.error('Erro:', error);
                resultsDisplayDiv.innerHTML = '<p>Erro ao carregar os dados. Tente novamente.</p>';
            }
        }


        stateSelect.addEventListener('change', (event) => {
            const selectedStateId = event.target.value;
            populateCitiesDropdown(selectedStateId);
        });

        citySelect.addEventListener('change', (event) => {
            const selectedCityId = event.target.value;
            populateProductsDropdown(selectedCityId);
        });

        // Adiciona um listener ao dropdown de produtos
        produtoSelect.addEventListener('change', () => {
            displayDetailedData();
        });

        // Inicializa os dropdowns
        citySelect.disabled = true;
        produtoSelect.disabled = true;

        populateStatesDropdown();
    });
</script>

{% endblock %}
