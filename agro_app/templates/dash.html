{% extends 'base.html' %}
{% load static %}

{% block content %}

<div class="dashboard-grid">

    {# inicio card1 #}
    <div class="dash-card dash-card-full">
        <h2 class="sub-title">Bem-vindo √† Dashboard do AgroData</h2>
        <p>Ol√°, {{ request.user.username }}! Esta √© a sua dashboard pessoal.</p>
        <p>Voc√™ est√° em **{{ city_name|default:"-" }} / {{ state_name|default:"-" }}**</p>
        <p id="current-date"></p>
    </div>
    {# fim card1 #}

    {# inicio card2 #}
    <div class="dash-card">
        <h4>Detalhes do Clima em {{ city_name|default:"-" }}</h4>
        {% if weather_data %}
            <p><strong>Umidade:</strong> {{ weather_data.main.humidity|default:"-" }}%</p>
            <p><strong>Vento:</strong> {{ weather_data.wind.speed|default:"-" }} m/s</p>
            <p><strong>Press√£o:</strong> {{ weather_data.main.pressure|default:"-" }} hPa</p>
        {% else %}
            <p>Dados de clima n√£o dispon√≠veis.</p>
        {% endif %}
    </div>
    {# fim card2 #}

    {# inicio card3 #}
    <div class="dash-card">
        <h4>Condi√ß√£o do Tempo em {{ city_name|default:"-" }}</h4>
        {% if weather_data %}
            <p>**{{ weather_data.weather.0.description|default:"-"|title }}**</p>
        {% else %}
            <p>Dados de clima n√£o dispon√≠veis.</p>
        {% endif %}
    </div>
    {# fim card3 #}

    {# inicio card4 - este card vai ocupar 2 espacos #}
    <div class="dash-card dash-card-wide">
    <h4>Temperatura em {{ city_name|default:"-" }}</h4>
    {% if weather_data %}
        <p style="font-size: 2.5rem; font-weight: bold; margin: 0;">{{ weather_data.main.temp|floatformat:"0" }}¬∞C</p>
        <p>Sensa√ß√£o t√©rmica: {{ weather_data.main.feels_like|floatformat:"0" }}¬∞C</p>
        <p>M√≠nima: {{ weather_data.main.temp_min|floatformat:"0" }}¬∞C / M√°xima: {{ weather_data.main.temp_max|floatformat:"0" }}¬∞C</p>
    {% else %}
        <p>Dados de temperatura n√£o dispon√≠veis.</p>
    {% endif %}
    </div>
    {# fim card4 #}

    <div class="filter-results-container dash-card-full">
        {# inicio card5 - Filtros #}
        <div class="dash-card">
            <h4>Filtros de Agropecu√°ria</h4>
            <p>Selecione um produto para come√ßar:</p>

            <p>1. Selecione o Estado:</p>
            <select id="state-select" class="form-field">
                <option value="">Carregando estados...</option>
            </select>

            <p>2. Selecione a Cidade:</p>
            <select id="city-select" class="form-field">
                <option value="">Selecione um estado primeiro</option>
            </select>

            <p>3. Selecione o Tipo de Cultivo:</p>
            <select id="produto-select" class="form-field">
                <option value="">Selecione uma cidade primeiro</option>
            </select>
            <div id="produto-error-message" style="color: red; margin-top: 5px; display: none;"></div>
        </div>
        {# fim card5 #}

        {# inicio card de Resultados - Nova Linha #}
        <div class="dash-card">
            <h4>Dados Detalhados</h4>
            <div id="results-display">
                <p>Selecione um estado, cidade e cultivo para ver os dados.</p>
            </div>
        </div>
        {# fim card de Resultados #}
    </div>

    {# inicio card6 #}
    <div class="dash-card dash-card-responsive-half">
        <h4>‚öôÔ∏è Sugest√µes de Plantio para {{ city_name|default:"sua Regi√£o" }}</h4>
        <p>Baseado no hist√≥rico de **Maior Rendimento (kg/ha)** e **Maior Valor (R$)** na sua cidade.</p>

        {% if suggestions %}
            <ul class="suggestion-list">
                {% for suggestion in suggestions %}
                    <li class="suggestion-item rank-{{ forloop.counter }}">
                        <span>
                            **{{ forloop.counter }}¬∫** - {{ suggestion.name }}
                            <small>({{ suggestion.rendimento|floatformat:"0" }} kg/ha / R$ {{ suggestion.valor|floatformat:"0" }})</small>
                        </span>
                        <span class="suggestion-score">{{ suggestion.score }}%</span>
                    </li>
                {% endfor %}
            </ul>
        {% else %}
            {% if profile.city %}
                <p>N√£o foi poss√≠vel gerar sugest√µes com base nos dados hist√≥ricos da sua cidade. Certifique-se de que a cidade cadastrada possui dados de produ√ß√£o ou tente outra localiza√ß√£o.</p>
            {% else %}
                <p>Por favor, complete seu cadastro de localiza√ß√£o para receber as sugest√µes.</p>
            {% endif %}
        {% endif %}
    </div>
    {# fim card6 #}

    {# inicio card7 - Gerenciamento de Terrenos #}
    <div class="dash-card dash-card-responsive-half">
        <h4>üå± Gerenciamento de Terrenos</h4>
        <p>Cadastre e acompanhe os seus terrenos e o cultivo principal em cada um.</p>

        <!-- Formul√°rio de Cria√ß√£o de Terreno -->
        <div class="terreno-form-container" id="terreno-create-form">
            <h5>Cadastrar Novo Terreno</h5>
            <form method="post" action="{% url 'agro_app:create_terreno' %}">
                {% csrf_token %}
                <!-- Renderiza os campos do formul√°rio -->
                {% for field in terreno_form %}
                    <p>
                        <label for="{{ field.id_for_label }}">{{ field.label }}:</label>
                        {{ field }}
                        {% if field.errors %}
                            <ul style="color: red; list-style: none; padding: 0; font-size: 0.9em;">
                                {% for error in field.errors %}<li>{{ error }}</li>{% endfor %}
                            </ul>
                        {% endif %}
                    </p>
                {% endfor %}
                <button type="submit" class="edit-btn" style="width: 100%; margin-top: 10px;">Salvar Terreno</button>
            </form>
        </div>

        <h5 style="margin-top: 30px; border-bottom: 1px solid #eee; padding-bottom: 5px;">Seus Terrenos Atuais ({{ terrenos|length }})</h5>

        {% if terrenos %}
            <ul class="terreno-list">
                {% for terreno in terrenos %}
                    <li class="terreno-item">
                        <div class="terreno-details">
                            <strong>{{ terreno.name }}</strong>
                            {# CORRE√á√ÉO DA √ÅREA (feito antes, mas mantido para estabilidade) #}
                            <small>| √Årea: **{{ terreno.area|default:"0"|floatformat:"0" }} ha** | Cultivo: {{ terreno.cultivo_principal|default:"N√£o definido" }}</small>
                        </div>
                        <div class="terreno-actions">
                            <!-- Bot√£o de Edi√ß√£o AGORA √â UM LINK PARA O NOVO TEMPLATE -->
                            <a href="{% url 'agro_app:edit_terreno' pk=terreno.pk %}" class="edit-btn">
                                Editar
                            </a>
                            <!-- Formul√°rio de Exclus√£o com confirma√ß√£o JS -->
                            <form method="post" action="{% url 'agro_app:delete_terreno' pk=terreno.pk %}" style="display:inline;" onsubmit="return confirmDelete(event, '{{ terreno.name|escapejs }}')">
                                {% csrf_token %}
                                <button type="submit" class="delete-btn">Excluir</button>
                            </form>
                        </div>
                    </li>
                {% endfor %}
            </ul>
        {% else %}
            <p style="margin-top: 10px;">Voc√™ ainda n√£o tem terrenos cadastrados. Use o formul√°rio acima para adicionar o seu primeiro.</p>
        {% endif %}
    </div>
    {# fim card7 #}


    {# inicio card8 #}
    <div class="dash-card dash-card-responsive-half">
        <h4>Cota√ß√µes</h4>
        <p>Fonte: CEPEA</p>

        <!-- Widgets Produtos Cepea - www.cepea.esalq.com.br/br/widget.aspx -->
        <script type="text/javascript" src="https://www.cepea.org.br/br/widgetproduto.js.php?fonte=arial&tamanho=10&largura=400px&corfundo=dbd6b2&cortexto=333333&corlinha=ede7bf&id_indicador%5B%5D=54&id_indicador%5B%5D=91&id_indicador%5B%5D=53&id_indicador%5B%5D=23&id_indicador%5B%5D=24&id_indicador%5B%5D=381-1&id_indicador%5B%5D=380-1&id_indicador%5B%5D=378-420&id_indicador%5B%5D=72&id_indicador%5B%5D=77&id_indicador%5B%5D=12&id_indicador%5B%5D=179"></script>

    </div>
    {# fim card8 #}


</div>

<script>
    // ** Fun√ß√µes de Confirma√ß√£o (Card 7) **

    /**
     * Confirma√ß√£o de Exclus√£o.
     */
    function confirmDelete(event, terrenoName) {
        // NOTE: Usamos window.confirm() pois √© uma fun√ß√£o nativa que simula uma modal simples.
        if (!window.confirm(`Tem certeza que deseja excluir o terreno "${terrenoName}"? Esta a√ß√£o n√£o pode ser desfeita.`)) {
            event.preventDefault(); // Impede o envio do formul√°rio se o usu√°rio cancelar
            return false;
        }
        return true;
    }


    const GET_STATES_URL = "{% url 'agro_app:get_states' %}";
    // Usamos um placeholder '0' ou 'placeholder' que ser√° substitu√≠do no JS
    const GET_CITIES_URL_TEMPLATE = "{% url 'agro_app:get_cities' 0 %}";
    const GET_PRODUCTS_BY_CITY_URL_TEMPLATE = "{% url 'agro_app:get_products_by_city' 'placeholder' %}";
    const GET_DETAILED_DATA_URL_TEMPLATE = "{% url 'agro_app:get_detailed_data' 'placeholder1' 'placeholder2' %}";

    // ** Fun√ß√µes de L√≥gica da Dashboard (Existentes) **
    document.addEventListener('DOMContentLoaded', function() {
        const stateSelect = document.getElementById('state-select');
        const citySelect = document.getElementById('city-select');
        const produtoSelect = document.getElementById('produto-select');
        const produtoErrorMessageDiv = document.getElementById('produto-error-message');
        const resultsDisplayDiv = document.getElementById('results-display');
        const currentDateParagraph = document.getElementById('current-date');

        // Adiciona a data atual ao card 1
        const date = new Date();
        const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
        const formattedDate = date.toLocaleDateString('pt-BR', options);
        currentDateParagraph.textContent = `Hoje √© ${formattedDate}.`;

        async function populateStatesDropdown() {
            stateSelect.innerHTML = '<option value="">Carregando estados...</option>';
            stateSelect.disabled = true;
            try {
                // CHAMA A URL GERADA PELO DJANGO: GET_STATES_URL
                const response = await fetch(GET_STATES_URL);
                if (!response.ok) {
                    // Logamos o erro para debug, mas o template tag garante que a URL est√° correta.
                    throw new Error('Erro ao carregar os estados. URL: ' + GET_STATES_URL);
                }
                const states = await response.json();
                stateSelect.innerHTML = '<option value="">Selecione um estado...</option>';
                states.forEach(state => {
                    const option = document.createElement('option');
                    option.value = state.id;
                    option.textContent = state.nome;
                    stateSelect.appendChild(option);
                });
            } catch (error) {
                console.error('Erro:', error);
                stateSelect.innerHTML = '<option value="">Erro ao carregar estados</option>';
            } finally {
                stateSelect.disabled = false;
            }
        }

        async function populateCitiesDropdown(stateId) {
            produtoSelect.innerHTML = '<option value="">Selecione uma cidade primeiro</option>';
            produtoSelect.disabled = true;
            if (!stateId) {
                citySelect.innerHTML = '<option value="">Selecione um estado primeiro</option>';
                citySelect.disabled = true;
                return;
            }
            citySelect.innerHTML = '<option value="">Carregando cidades...</option>';
            citySelect.disabled = true;
            try {
                // GERA A URL COM O ID DO ESTADO
                const url = GET_CITIES_URL_TEMPLATE.replace('0', stateId);
                const response = await fetch(url);
                if (!response.ok) {
                    throw new Error('Erro ao carregar as cidades. URL: ' + url);
                }
                const cities = await response.json();
                citySelect.innerHTML = '<option value="">Selecione uma cidade...</option>';
                cities.forEach(city => {
                    const option = document.createElement('option');
                    option.value = city.id;
                    option.textContent = city.nome;
                    citySelect.appendChild(option);
                });
            } catch (error) {
                console.error('Erro:', error);
                citySelect.innerHTML = '<option value="">Erro ao carregar cidades</p>';
            } finally {
                citySelect.disabled = false;
            }
        }

        async function populateProductsDropdown(cityId) {
            produtoErrorMessageDiv.style.display = 'none';
            produtoSelect.disabled = true;
            if (!cityId) {
                produtoSelect.innerHTML = '<option value="">Selecione uma cidade primeiro</option>';
                return;
            }
            produtoSelect.innerHTML = '<option value="">Carregando produtos...</option>';
            try {
                const cityResponse = await fetch(`https://servicodados.ibge.gov.br/api/v1/localidades/municipios/${cityId}`);
                if (!cityResponse.ok) {
                    throw new Error('Erro ao carregar dados da cidade.');
                }
                const cityData = await cityResponse.json();
                const cityName = cityData.nome;

                // GERA A URL COM O NOME DA CIDADE
                const url = GET_PRODUCTS_BY_CITY_URL_TEMPLATE.replace('placeholder', cityName);
                const productsResponse = await fetch(url);
                if (!productsResponse.ok) {
                    throw new Error('Erro ao carregar os produtos. URL: ' + url);
                }

                const products = await productsResponse.json();

                if (products.length > 0) {
                    produtoSelect.innerHTML = '<option value="">Selecione um produto...</option>';
                    products.forEach(product => {
                        const option = document.createElement('option');
                        option.value = product.id;
                        option.textContent = product.nome;
                        produtoSelect.appendChild(option);
                    });
                } else {
                    produtoSelect.innerHTML = '<option value="">Nenhum produto encontrado</option>';
                }
            } catch (error) {
                console.error('Erro:', error);
                produtoErrorMessageDiv.textContent = 'Erro ao carregar os produtos.';
                produtoErrorMessageDiv.style.display = 'block';
                produtoSelect.innerHTML = '<option value="">Erro</option>';
            } finally {
                produtoSelect.disabled = false;
            }
        }

        // Fun√ß√£o para exibir os dados detalhados
        async function displayDetailedData() {
            const selectedCityId = citySelect.value;
            const selectedProductId = produtoSelect.value;

            if (!selectedCityId || !selectedProductId) {
                resultsDisplayDiv.innerHTML = '<p>Selecione um estado, cidade e cultivo para ver os dados.</p>';
                return;
            }

            resultsDisplayDiv.innerHTML = '<p>Carregando dados...</p>';

            try {
                const cityResponse = await fetch(`https://servicodados.ibge.gov.br/api/v1/localidades/municipios/${selectedCityId}`);
                const cityData = await cityResponse.json();
                const cityName = cityData.nome;

                // GERA A URL COM CIDADE E PRODUTO
                let url = GET_DETAILED_DATA_URL_TEMPLATE.replace('placeholder1', cityName);
                url = url.replace('placeholder2', selectedProductId);

                const response = await fetch(url);
                if (!response.ok) {
                    throw new Error('Erro ao carregar os dados detalhados. URL: ' + url);
                }
                const data = await response.json();

                let htmlContent = '<h4>Informa√ß√µes para ' + cityName + '</h4><ul>';
                for (const key in data) {
                    if (data.hasOwnProperty(key)) {
                        htmlContent += '<li><strong>' + key + ':</strong> ' + data[key] + '</li>';
                    }
                }
                htmlContent += '</ul>';

                resultsDisplayDiv.innerHTML = htmlContent;

            } catch (error) {
                console.error('Erro:', error);
                resultsDisplayDiv.innerHTML = '<p>Erro ao carregar os dados. Tente novamente.</p>';
            }
        }


        stateSelect.addEventListener('change', (event) => {
            const selectedStateId = event.target.value;
            populateCitiesDropdown(selectedStateId);
        });

        citySelect.addEventListener('change', (event) => {
            const selectedCityId = event.target.value;
            populateProductsDropdown(selectedCityId);
        });

        // Adiciona um listener ao dropdown de produtos
        produtoSelect.addEventListener('change', () => {
            displayDetailedData();
        });

        // Inicializa os dropdowns
        citySelect.disabled = true;
        produtoSelect.disabled = true;

        populateStatesDropdown();
    });
</script>

{% endblock %}
